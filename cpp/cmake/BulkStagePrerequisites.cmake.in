# cmake/BulkStagePrerequisites.cmake
# Generated by configure_file() â€” do not edit directly.
# Values are substituted at configure time.

# This script copies common directories (lib, include, share, package) from
# PREREQ_DIR to STAGING_DIR and handles platform-specific needs, such as
# moving DLLs on Windows.

# - PREREQ_DIR: The source directory containing the installed prerequisites.
# - STAGING_DIR: The destination unified staging directory.
#

set(PREREQ_DIR "@PREREQ_INSTALL_DIR@")
set(STAGING_DIR "@PYLABHUB_STAGING_DIR@")

# Defensive checks (same as before)
if(NOT PREREQ_DIR OR PREREQ_DIR STREQUAL "" OR NOT STAGING_DIR OR STAGING_DIR STREQUAL "")
  message(FATAL_ERROR
    "BulkStagePrerequisites.cmake requires non-empty PREREQ_DIR and STAGING_DIR.\n"
    "Resolved: PREREQ_DIR='${PREREQ_DIR}' STAGING_DIR='${STAGING_DIR}'\n"
  )
endif()

message(STATUS "BulkStagePrerequisites: PREREQ_DIR=${PREREQ_DIR}")
message(STATUS "BulkStagePrerequisites: STAGING_DIR=${STAGING_DIR}")

set(subdirs_to_copy bin lib include share)

foreach(subdir ${subdirs_to_copy})
  set(source_path "${PREREQ_DIR}/${subdir}")
  set(dest_path "${STAGING_DIR}/${subdir}")
  if(EXISTS "${source_path}")
    message(STATUS "  - Staging directory: ${source_path} -> ${dest_path}")
    file(COPY_DIRECTORY "${source_path}/" DESTINATION "${dest_path}/")
  else()
    message(STATUS "  - Skipping non-existent prerequisite directory: ${source_path}")
  endif()
endforeach()

# On Windows, find DLLs in the staged lib directory and copy them to bin/ and tests/
if(WIN32) # Use WIN32 as a proxy for PYLABHUB_IS_WINDOWS here, as this script runs in isolation
  set(staged_lib_dir "${STAGING_DIR}/lib")
  if(EXISTS "${staged_lib_dir}")
      file(GLOB_RECURSE dlls_to_stage "${staged_lib_dir}/*.dll")

      if(dlls_to_stage)
          message(STATUS "  - Found DLLs to stage to runtime directories: ${dlls_to_stage}")
          set(runtime_dest_bin "${STAGING_DIR}/bin")
          set(runtime_dest_tests "${STAGING_DIR}/tests")

          file(COPY ${dlls_to_stage} DESTINATION "${runtime_dest_bin}")
          file(COPY ${dlls_to_stage} DESTINATION "${runtime_dest_tests}")
          message(STATUS "  - Copied DLLs to ${runtime_dest_bin} and ${runtime_dest_tests}")
      endif()
  endif()
endif()
