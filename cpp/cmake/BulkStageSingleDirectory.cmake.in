# cmake/BulkStageSingleDirectory.cmake
# Generated by configure_file() â€” do not edit directly.
# Values are substituted at configure time.
#
# - SOURCE_DIR: The source directory containing the installed artifacts.
# - STAGING_ROOT_DIR: The destination unified staging directory.
# - SUBDIRS_TO_COPY: A CMake list (semicolon-separated) of subdirectories within SOURCE_DIR to copy.

set(SOURCE_DIR "@SOURCE_DIR@")
set(STAGING_ROOT_DIR "@STAGING_ROOT_DIR@")
# SUBDIRS_TO_COPY should be a semicolon-separated list when substituted by configure_file()
set(SUBDIRS_TO_COPY "@SUBDIRS_TO_COPY@")

# Normalize paths for cross-platform stability
file(TO_CMAKE_PATH "${SOURCE_DIR}" SOURCE_DIR)
file(TO_CMAKE_PATH "${STAGING_ROOT_DIR}" STAGING_ROOT_DIR)

# Defensive checks
if(NOT SOURCE_DIR OR SOURCE_DIR STREQUAL "" OR NOT STAGING_ROOT_DIR OR STAGING_ROOT_DIR STREQUAL "")
  message(FATAL_ERROR
    "BulkStageSingleDirectory.cmake requires non-empty SOURCE_DIR and STAGING_ROOT_DIR.\n"
    "Resolved: SOURCE_DIR='${SOURCE_DIR}' STAGING_ROOT_DIR='${STAGING_ROOT_DIR}'\n"
  )
endif()

message(STATUS "[pylabhub-staging] SOURCE_DIR=${SOURCE_DIR}")
message(STATUS "[pylabhub-staging] STAGING_ROOT_DIR=${STAGING_ROOT_DIR}")
message(STATUS "[pylabhub-staging] SUBDIRS_TO_COPY='${SUBDIRS_TO_COPY}'")

# If SUBDIRS_TO_COPY was substituted as an empty string, skip the loop gracefully.
if(NOT SUBDIRS_TO_COPY OR SUBDIRS_TO_COPY STREQUAL "")
  message(STATUS "[pylabhub-staging] No subdirectories configured to copy (SUBDIRS_TO_COPY is empty).")
else()
  foreach(subdir IN LISTS SUBDIRS_TO_COPY)
    if(NOT subdir) # skip accidental empty elements
      continue()
    endif()

    # Build source and destination paths and normalize
    file(TO_CMAKE_PATH "${SOURCE_DIR}/${subdir}" source_path)
    file(TO_CMAKE_PATH "${STAGING_ROOT_DIR}/${subdir}" dest_path)

    if(EXISTS "${source_path}")
      message(STATUS "[pylabhub-staging] Staging directory: ${source_path} -> ${dest_path}")
      # ensure destination exists
      file(MAKE_DIRECTORY "${dest_path}")
      # copy directory contents (preserve structure)
      file(COPY "${source_path}/" DESTINATION "${dest_path}/")
    else()
      message(STATUS "[pylabhub-staging] Skipping non-existent subdirectory: ${source_path}")
    endif()
  endforeach()
endif()

# On Windows copy DLLs discovered under staged lib into runtime bin/tests directories.
if(WIN32)
  file(TO_CMAKE_PATH "${STAGING_ROOT_DIR}/lib" staged_lib_dir)
  if(EXISTS "${staged_lib_dir}")
    file(GLOB_RECURSE dlls_to_stage RELATIVE "${staged_lib_dir}" "${staged_lib_dir}/*.dll")
    if(dlls_to_stage)
      # Expand to absolute paths for file(COPY)
      set(_abs_dlls)
      foreach(_rel IN LISTS dlls_to_stage)
        list(APPEND _abs_dlls "${staged_lib_dir}/${_rel}")
      endforeach()

      message(STATUS "[pylabhub-staging] Found DLLs to stage to runtime directories: ${_abs_dlls}")
      set(runtime_dest_bin "${STAGING_ROOT_DIR}/bin")
      set(runtime_dest_tests "${STAGING_ROOT_DIR}/tests")

      file(MAKE_DIRECTORY "${runtime_dest_bin}")
      file(MAKE_DIRECTORY "${runtime_dest_tests}")

      file(COPY ${_abs_dlls} DESTINATION "${runtime_dest_bin}")
      file(COPY ${_abs_dlls} DESTINATION "${runtime_dest_tests}")
      message(STATUS "[pylabhub-staging] Copied DLLs to ${runtime_dest_bin} and ${runtime_dest_tests}")
    else()
      message(STATUS "[pylabhub-staging] No DLLs found under ${staged_lib_dir}")
    endif()
  else()
    message(STATUS "[pylabhub-staging] No staged lib directory: ${staged_lib_dir}")
  endif()
endif()
