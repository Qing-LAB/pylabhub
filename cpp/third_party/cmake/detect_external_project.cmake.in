# detect_external_project.cmake.in
# expects the following variables to be set:
#   PACKAGE_NAME         - package short name (e.g., luajit, libsodium, libzmq)
#   PREREQ_INSTALL_DIR   - install dir used by the external project's install
#   PACKAGE_BINARY_DIR   - binary dir used for the build
#   LIB_PATTERNS         - semicolon-separated list of glob patterns to search for libs
#   HEADER_SOURCE_PATTERNS - semicolon-separated list of header relative paths to copy
#   STABLE_BASENAME      - basename to write stable lib (e.g., "luajit-stable")
#
message(STATUS "detect: PACKAGE_NAME=${PACKAGE_NAME}")
message(STATUS "detect: PREREQ_INSTALL_DIR=${PREREQ_INSTALL_DIR}")
message(STATUS "detect: PACKAGE_BINARY_DIR=${PACKAGE_BINARY_DIR}")

set(_found_lib "")
if(LIB_PATTERNS)
  string(REPLACE ";" "|" _lib_regex "${LIB_PATTERNS}")
  # try search in install lib directory first
  file(GLOB_RECURSE _candidates RELATIVE "${PREREQ_INSTALL_DIR}"
    "${PREREQ_INSTALL_DIR}/lib/*"
  )
  foreach(_c ${_candidates})
    foreach(_pat ${LIB_PATTERNS})
      if("${_c}" MATCHES "${_pat}")
        set(_found_lib "${PREREQ_INSTALL_DIR}/lib/${_c}")
        break()
      endif()
    endforeach()
    if(_found_lib)
      break()
    endif()
  endforeach()
endif()

# fallback: scan binary dir for common library suffixes
if(NOT _found_lib)
  file(GLOB _bin_libs
    "${PACKAGE_BINARY_DIR}/*/*.a"
    "${PACKAGE_BINARY_DIR}/*/*.so"
    "${PACKAGE_BINARY_DIR}/*/*.dylib"
    "${PACKAGE_BINARY_DIR}/*/*.lib"
    "${PACKAGE_BINARY_DIR}/*.a"
    "${PACKAGE_BINARY_DIR}/*.so"
    "${PACKAGE_BINARY_DIR}/*.dylib"
    "${PACKAGE_BINARY_DIR}/*.lib"
  )
  if(_bin_libs)
    list(GET _bin_libs 0 _found_lib)
  endif()
endif()

if(NOT _found_lib)
  message(WARNING "detect: unable to find library artifact for ${PACKAGE_NAME}. Attempting relaxed search under install/lib")
  file(GLOB _relaxed "${PREREQ_INSTALL_DIR}/lib/*${PACKAGE_NAME}*.*")
  if(_relaxed)
    list(GET _relaxed 0 _found_lib)
  endif()
endif()

if(NOT _found_lib)
  message(FATAL_ERROR "detect: could not discover built artifact for ${PACKAGE_NAME}. Checked install and binary dirs.")
endif()

message(STATUS "detect: discovered artifact: ${_found_lib}")

# determine extension and stable path
get_filename_component(_found_name "${_found_lib}" NAME)
get_filename_component(_found_ext "${_found_lib}" EXT)
set(_stable_lib_path "${PREREQ_INSTALL_DIR}/lib/${STABLE_BASENAME}${_found_ext}")

# copy/rename artifact to stable path (overwrite if exists)
file(COPY "${_found_lib}" DESTINATION "${PREREQ_INSTALL_DIR}/lib")
# rename from the copied filename
file(RENAME "${PREREQ_INSTALL_DIR}/lib/${_found_name}" "${_stable_lib_path}")

message(STATUS "detect: wrote stable artifact to ${_stable_lib_path}")

# handle headers: if header patterns provided, copy them into include/<pkg> subdir
if(DEFINED HEADER_SOURCE_PATTERNS AND HEADER_SOURCE_PATTERNS)
  set(_hdr_dir "${PREREQ_INSTALL_DIR}/include/${PACKAGE_NAME}")
  file(MAKE_DIRECTORY "${_hdr_dir}")
  foreach(_hp IN LISTS HEADER_SOURCE_PATTERNS)
    # first try in source include paths under PACKAGE_BINARY_DIR
    set(_try1 "${PACKAGE_BINARY_DIR}/${_hp}")
    if(EXISTS "${_try1}")
      file(COPY "${_try1}" DESTINATION "${_hdr_dir}")
      continue()
    endif()
    # next try PREREQ_INSTALL_DIR
    set(_try2 "${PREREQ_INSTALL_DIR}/${_hp}")
    if(EXISTS "${_try2}")
      file(COPY "${_try2}" DESTINATION "${_hdr_dir}")
      continue()
    endif()
    # if not found, warn but continue
    message(WARNING "detect: header pattern ${_hp} not found for ${PACKAGE_NAME}")
  endforeach()
endif()

# write stamp file
file(WRITE "${PREREQ_INSTALL_DIR}/${PACKAGE_NAME}-stamp.txt" "OK")
message(STATUS "detect: wrote stamp ${PREREQ_INSTALL_DIR}/${PACKAGE_NAME}-stamp.txt")
