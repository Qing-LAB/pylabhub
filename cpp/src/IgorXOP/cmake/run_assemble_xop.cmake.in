# cmake/run_assemble_xop.cmake.in
# ------------------------------------------------------------------------------
# This is a "bootstrap" script executed by a POST_BUILD command.
#
# Its purpose is to take build-time variables (passed via -D on the command line)
# and use them to configure the *actual* assembly script. This two-step process
# is necessary to correctly resolve CMake generator expressions like
# $<TARGET_FILE:...> into concrete paths.
# ------------------------------------------------------------------------------

message(STATUS "run_assemble_xop.cmake: Bootstrapping assembly process...")

# 1. Validate that the required build-time path was passed in.
if(NOT DEFINED MACHO_BINARY_PATH_ARG)
  message(FATAL_ERROR "MACHO_BINARY_PATH_ARG was not provided to the bootstrap script.")
endif()

# 2. Set the variable that the final assembly script template expects.
#    MACHO_BINARY_PATH_ARG is passed via -D on the command line to resolve the generator expression.
#    The rest are passed via configure_file from the parent CMakeLists.txt.
set(MACHO_BINARY_PATH "${MACHO_BINARY_PATH_ARG}")
set(BUNDLE_DIR "@BUNDLE_DIR@")
set(XOP_BUNDLE_NAME "@XOP_BUNDLE_NAME@")
set(CONFIGURED_INFO_PLIST "@CONFIGURED_INFO_PLIST@")
set(INFO_PLIST_STRINGS_SOURCE "@INFO_PLIST_STRINGS_SOURCE@")
set(REZ_SOURCE_FILE "@REZ_SOURCE_FILE@")
set(R_INCLUDE_DIRS_LIST "@R_INCLUDE_DIRS_LIST@")

# 3. Use configure_file to create the final, fully-resolved assembly script.
#    This passes the now-resolved variables into the main script.
configure_file("@ASSEMBLE_SCRIPT_TEMPLATE@" "@CONFIGURED_ASSEMBLE_SCRIPT@" @ONLY)

# 4. Execute the final assembly script.
message(STATUS "run_assemble_xop.cmake: Executing final assembly script: @CONFIGURED_ASSEMBLE_SCRIPT@")
include("@CONFIGURED_ASSEMBLE_SCRIPT@")

# 5. After assembly, run the processing script (clean, sign, verify).
set(PROCESS_SCRIPT_PATH "@PROCESS_BUNDLE_SCRIPT_PATH@")
if(EXISTS "${PROCESS_SCRIPT_PATH}")
    message(STATUS "run_assemble_xop.cmake: Executing bundle processing script.")
    execute_process(
        COMMAND ${CMAKE_COMMAND}
          -D "BUNDLE_PATH=@BUNDLE_DIR@"
          -D "EXECUTABLE_NAME=@XOP_BUNDLE_NAME@"
          -D "SIGNING_IDENTITY=@MACOSX_CODESIGN_IDENTITY@"
          -D "CODESIGN_SCRIPT_PATH=@CODESIGN_SCRIPT_PATH@"
          -D "VERIFY_SCRIPT_PATH=@VERIFY_SCRIPT_PATH@"
          -P "${PROCESS_SCRIPT_PATH}"
        RESULT_VARIABLE result
    )
    if(NOT result EQUAL 0)
        message(FATAL_ERROR "Bundle processing script failed with exit code ${result}.")
    endif()
else()
    message(WARNING "run_assemble_xop.cmake: Bundle processing script not found at ${PROCESS_SCRIPT_PATH}. Skipping.")
endif()